#
# Copyright 2016 Blockie AB
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
_clone:
    @clone: os file string
@include: |/_clone/

# spacegal/ssh
#
# Functionality to SSH into other machines.

_dep_install:
    _info:
        title: Check dependencies for this module.
    _env:
        - RUN: SSH_DEP_INSTALL

_info:
    title: SSH module
    desc:|
        Provides common admin and user ssh client operations.

keygen:
    _info:
        title: Generate SSH key pair
    _env:
        - RUN: SSH_KEYGEN -- ${SSHKEYFILE-} ${SSHPUBKEYFILE-}

root:
    _info:
        title: SSH as root using password
    _env:
        - RUN: SSH "${SSHFLAGS-}" "root" "$SSHHOST" "${SSHPORT-}" "" "${SSHSHELL-}" --
    wrap:
        _info:
            title: Wrap other command in SSH invocation.
        _env:
            - SSHUSER: root
            - SPACE_WRAP: SSH_WRAP
user:
    _info:
        title: SSH as user with a keyfile
    _env:
        - RUN: SSH "${SSHFLAGS-}" "$SSHUSER" "$SSHHOST" "${SSHPORT-}" "${SSHKEYFILE-}" "${SSHSHELL-}" --
    wrap:
        _info:
            title: Wrap other command in SSH invocation.
        _env:
            - SPACE_WRAP: SSH_WRAP

addsshkey:
    _info:
        title: Add public key
        desc:|
            Add a ssh public key to a remote users authorized_keys file.
    _env:
        - targetuser: ${targetuser:-${SSHUSER-}}
        - RUN: SSH_ADD_SSH_KEY ${targetuser} --

resetsshkey:
    _info:
        title: Reset ssh key
        desc: |
            Reset the remote users authorized_keys file to only hold one pub key.
            The pub key uploaded should be the current one being used by you.
    _env:
        - targetuser: ${targetuser:-${SSHUSER-}}
        - targetuserpubkeyfile: ${targetuserpubkeyfile:-${SSHPUBKEYFILE-}}
        - RUN: SSH_RESET_SSH_KEY -- ${targetuser} ${targetuserpubkeyfile}

configsshd:
    _info:
        title: Configure SSHD
        desc:|
            Make sure that SSHD is properly configured.
    _env:
        - RUN: SSH_SSHD_CONFIG
...
